name: Notify Clark

on:
  issues:
    types: [opened, closed, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, closed, reopened]
  pull_request_review:
    types: [submitted]
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          EVENT="${{ github.event_name }}"
          ACTION="${{ github.event.action }}"
          REPO="${{ github.repository }}"
          SENDER="${{ github.actor }}"
          
          case "$EVENT" in
            issues)
              TITLE=$(echo '${{ github.event.issue.title }}' | head -c 100)
              NUMBER="${{ github.event.issue.number }}"
              URL="${{ github.event.issue.html_url }}"
              
              if [ "$ACTION" = "opened" ]; then
                MSG="üÜï **New Issue #$NUMBER** in \`$REPO\`
**$TITLE**
By: $SENDER
$URL"
              elif [ "$ACTION" = "closed" ]; then
                MSG="‚úÖ **Issue #$NUMBER closed** in \`$REPO\`
**$TITLE** - By: $SENDER"
              elif [ "$ACTION" = "reopened" ]; then
                MSG="üîÑ **Issue #$NUMBER reopened** in \`$REPO\`
**$TITLE** - By: $SENDER"
              fi
              ;;
            
            issue_comment)
              TITLE=$(echo '${{ github.event.issue.title }}' | head -c 100)
              NUMBER="${{ github.event.issue.number }}"
              URL="${{ github.event.comment.html_url }}"
              
              MSG="üí¨ **Comment on #$NUMBER** in \`$REPO\`
**$TITLE**
By: $SENDER
$URL"
              ;;
            
            pull_request)
              TITLE=$(echo '${{ github.event.pull_request.title }}' | head -c 100)
              NUMBER="${{ github.event.pull_request.number }}"
              URL="${{ github.event.pull_request.html_url }}"
              MERGED="${{ github.event.pull_request.merged }}"
              
              if [ "$ACTION" = "opened" ]; then
                MSG="üîÄ **New PR #$NUMBER** in \`$REPO\`
**$TITLE**
By: $SENDER
$URL"
              elif [ "$ACTION" = "closed" ]; then
                if [ "$MERGED" = "true" ]; then
                  MSG="üéâ **PR #$NUMBER merged** in \`$REPO\`
**$TITLE**"
                else
                  MSG="‚ùå **PR #$NUMBER closed** in \`$REPO\`
**$TITLE**"
                fi
              fi
              ;;
            
            pull_request_review)
              NUMBER="${{ github.event.pull_request.number }}"
              TITLE=$(echo '${{ github.event.pull_request.title }}' | head -c 100)
              STATE="${{ github.event.review.state }}"
              
              if [ "$STATE" = "approved" ]; then
                EMOJI="‚úÖ"
              elif [ "$STATE" = "changes_requested" ]; then
                EMOJI="üî¥"
              else
                EMOJI="üí≠"
              fi
              MSG="$EMOJI **PR #$NUMBER review** ($STATE) in \`$REPO\`
**$TITLE** - By: $SENDER"
              ;;
            
            release)
              TAG="${{ github.event.release.tag_name }}"
              NAME=$(echo '${{ github.event.release.name }}' | head -c 100)
              URL="${{ github.event.release.html_url }}"
              
              MSG="üöÄ **Release $TAG** in \`$REPO\`
**$NAME**
$URL"
              ;;
          esac
          
          if [ -n "$MSG" ]; then
            # Use jq to properly escape the message for JSON
            JSON=$(jq -n --arg content "$MSG" '{content: $content}')
            curl -X POST "$DISCORD_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d "$JSON"
          fi
