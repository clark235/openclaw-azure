name: Notify Clark

on:
  issues:
    types: [opened, closed, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, closed, reopened]
  pull_request_review:
    types: [submitted]
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Build message
        id: message
        run: |
          EVENT="${{ github.event_name }}"
          ACTION="${{ github.event.action }}"
          REPO="${{ github.repository }}"
          SENDER="${{ github.actor }}"
          
          case "$EVENT" in
            issues)
              TITLE="${{ github.event.issue.title }}"
              NUMBER="${{ github.event.issue.number }}"
              URL="${{ github.event.issue.html_url }}"
              
              if [ "$ACTION" = "opened" ]; then
                MSG="ðŸ†• **New Issue #$NUMBER** in \`$REPO\`\n**$TITLE**\nBy: $SENDER\n$URL"
              elif [ "$ACTION" = "closed" ]; then
                MSG="âœ… **Issue #$NUMBER closed** in \`$REPO\`\n**$TITLE**\nBy: $SENDER"
              elif [ "$ACTION" = "reopened" ]; then
                MSG="ðŸ”„ **Issue #$NUMBER reopened** in \`$REPO\`\n**$TITLE**\nBy: $SENDER"
              fi
              ;;
            
            issue_comment)
              TITLE="${{ github.event.issue.title }}"
              NUMBER="${{ github.event.issue.number }}"
              URL="${{ github.event.comment.html_url }}"
              
              MSG="ðŸ’¬ **Comment on #$NUMBER** in \`$REPO\`\n**$TITLE**\nBy: $SENDER\n$URL"
              ;;
            
            pull_request)
              TITLE="${{ github.event.pull_request.title }}"
              NUMBER="${{ github.event.pull_request.number }}"
              URL="${{ github.event.pull_request.html_url }}"
              MERGED="${{ github.event.pull_request.merged }}"
              
              if [ "$ACTION" = "opened" ]; then
                MSG="ðŸ”€ **New PR #$NUMBER** in \`$REPO\`\n**$TITLE**\nBy: $SENDER\n$URL"
              elif [ "$ACTION" = "closed" ]; then
                if [ "$MERGED" = "true" ]; then
                  MSG="ðŸŽ‰ **PR #$NUMBER merged** in \`$REPO\`\n**$TITLE**"
                else
                  MSG="âŒ **PR #$NUMBER closed** (not merged) in \`$REPO\`\n**$TITLE**"
                fi
              fi
              ;;
            
            pull_request_review)
              NUMBER="${{ github.event.pull_request.number }}"
              TITLE="${{ github.event.pull_request.title }}"
              STATE="${{ github.event.review.state }}"
              
              if [ "$STATE" = "approved" ]; then
                EMOJI="âœ…"
              elif [ "$STATE" = "changes_requested" ]; then
                EMOJI="ðŸ”´"
              else
                EMOJI="ðŸ’­"
              fi
              MSG="$EMOJI **PR #$NUMBER review ($STATE)** in \`$REPO\`\n**$TITLE**\nBy: $SENDER"
              ;;
            
            release)
              TAG="${{ github.event.release.tag_name }}"
              NAME="${{ github.event.release.name }}"
              URL="${{ github.event.release.html_url }}"
              
              MSG="ðŸš€ **Release $TAG** in \`$REPO\`\n**$NAME**\n$URL"
              ;;
          esac
          
          # Escape for JSON
          MSG=$(echo -e "$MSG" | jq -Rs .)
          echo "message=$MSG" >> $GITHUB_OUTPUT
      
      - name: Send to Discord
        if: steps.message.outputs.message != ''
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{\"content\": ${{ steps.message.outputs.message }}}"
