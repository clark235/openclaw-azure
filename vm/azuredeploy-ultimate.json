{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "description": "OpenCLAW Ultimate - Deploy with AI provider + messaging channel pre-configured",
    "_generator": { "name": "openclaw-azure", "version": "2.0.0" }
  },
  "parameters": {
    "vmName": {
      "type": "string",
      "defaultValue": "openclaw",
      "metadata": { "description": "VM name" }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": { "description": "Azure region" }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_B1ms",
      "allowedValues": ["Standard_B1ls", "Standard_B1s", "Standard_B1ms", "Standard_B2s", "Standard_B2ms"],
      "metadata": { "description": "VM size (~$16/mo for B1ms)" }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "clawdadmin",
      "metadata": { "description": "SSH username" }
    },
    "adminPasswordOrKey": {
      "type": "secureString",
      "metadata": { "description": "SSH public key (recommended) or password" }
    },
    "authenticationType": {
      "type": "string",
      "defaultValue": "sshPublicKey",
      "allowedValues": ["sshPublicKey", "password"],
      "metadata": { "description": "Authentication type" }
    },
    "aiProvider": {
      "type": "string",
      "defaultValue": "anthropic",
      "allowedValues": [
        "anthropic",
        "openai",
        "azure-openai",
        "openrouter",
        "google",
        "groq",
        "mistral",
        "xai"
      ],
      "metadata": { 
        "description": "AI model provider - Anthropic (Claude), OpenAI (GPT), Azure OpenAI, OpenRouter (many models), Google (Gemini), Groq (fast), Mistral, xAI (Grok)"
      }
    },
    "aiApiKey": {
      "type": "secureString",
      "defaultValue": "",
      "metadata": { 
        "description": "API key for your chosen AI provider (get from provider's console)"
      }
    },
    "azureOpenAiEndpoint": {
      "type": "string",
      "defaultValue": "",
      "metadata": { 
        "description": "Azure OpenAI endpoint URL (required if aiProvider is 'azure-openai'). Example: https://your-resource.openai.azure.com"
      }
    },
    "azureOpenAiDeploymentName": {
      "type": "string",
      "defaultValue": "gpt-4o",
      "metadata": { 
        "description": "Azure OpenAI deployment name (required if aiProvider is 'azure-openai')"
      }
    },
    "deployAzureOpenAI": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Deploy a new Azure OpenAI resource (requires Azure OpenAI access approval)"
      }
    },
    "azureOpenAiSku": {
      "type": "string",
      "defaultValue": "S0",
      "allowedValues": ["S0"],
      "metadata": { "description": "Azure OpenAI SKU" }
    },
    "messagingChannel": {
      "type": "string",
      "defaultValue": "none",
      "allowedValues": ["none", "telegram", "discord"],
      "metadata": { "description": "Pre-configure messaging channel" }
    },
    "telegramBotToken": {
      "type": "secureString",
      "defaultValue": "",
      "metadata": { "description": "Telegram bot token from @BotFather" }
    },
    "discordBotToken": {
      "type": "secureString",
      "defaultValue": "",
      "metadata": { "description": "Discord bot token" }
    }
  },
  "variables": {
    "vnetName": "[concat(parameters('vmName'), '-vnet')]",
    "subnetName": "default",
    "nsgName": "[concat(parameters('vmName'), '-nsg')]",
    "publicIpName": "[concat(parameters('vmName'), '-pip')]",
    "nicName": "[concat(parameters('vmName'), '-nic')]",
    "dnsLabel": "[concat('openclaw-', uniqueString(resourceGroup().id, parameters('vmName')))]",
    "gatewayToken": "[concat(uniqueString(resourceGroup().id, parameters('vmName'), deployment().name), uniqueString(subscription().subscriptionId, parameters('vmName')))]",
    "openAiResourceName": "[concat('openclaw-ai-', uniqueString(resourceGroup().id))]",
    
    "linuxConfiguration": {
      "disablePasswordAuthentication": true,
      "ssh": {
        "publicKeys": [{
          "path": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]",
          "keyData": "[parameters('adminPasswordOrKey')]"
        }]
      }
    },

    "providerEnvMap": {
      "anthropic": "ANTHROPIC_API_KEY",
      "openai": "OPENAI_API_KEY",
      "azure-openai": "AZURE_OPENAI_API_KEY",
      "openrouter": "OPENROUTER_API_KEY",
      "google": "GEMINI_API_KEY",
      "groq": "GROQ_API_KEY",
      "mistral": "MISTRAL_API_KEY",
      "xai": "XAI_API_KEY"
    },
    "providerModelMap": {
      "anthropic": "anthropic/claude-sonnet-4-5",
      "openai": "openai/gpt-4o",
      "azure-openai": "[concat('azure-openai/', parameters('azureOpenAiDeploymentName'))]",
      "openrouter": "openrouter/anthropic/claude-sonnet-4-5",
      "google": "google/gemini-2.0-flash",
      "groq": "groq/llama-3.3-70b-versatile",
      "mistral": "mistral/mistral-large-latest",
      "xai": "xai/grok-3"
    },
    
    "selectedEnvVar": "[variables('providerEnvMap')[parameters('aiProvider')]]",
    "selectedModel": "[variables('providerModelMap')[parameters('aiProvider')]]",
    
    "azureOpenAiProviderConfig": "[if(equals(parameters('aiProvider'), 'azure-openai'), concat(',\"models\":{\"providers\":{\"azure-openai\":{\"baseUrl\":\"', if(parameters('deployAzureOpenAI'), concat('https://', variables('openAiResourceName'), '.openai.azure.com'), parameters('azureOpenAiEndpoint')), '/openai/deployments/', parameters('azureOpenAiDeploymentName'), '\",\"api\":\"openai-chat\",\"auth\":\"api-key\",\"models\":[{\"id\":\"', parameters('azureOpenAiDeploymentName'), '\",\"name\":\"Azure OpenAI ', parameters('azureOpenAiDeploymentName'), '\"}]}}}'), '')]",
    
    "telegramConfig": "[if(and(equals(parameters('messagingChannel'), 'telegram'), not(empty(parameters('telegramBotToken')))), concat(',\"channels\":{\"telegram\":{\"enabled\":true,\"botToken\":\"', parameters('telegramBotToken'), '\",\"dmPolicy\":\"open\",\"dm\":{\"allowFrom\":[\"*\"]}}}'), '')]",
    "discordConfig": "[if(and(equals(parameters('messagingChannel'), 'discord'), not(empty(parameters('discordBotToken')))), concat(',\"channels\":{\"discord\":{\"enabled\":true,\"token\":\"', parameters('discordBotToken'), '\",\"dm\":{\"policy\":\"open\",\"allowFrom\":[\"*\"]}}}'), '')]",
    "channelConfig": "[if(equals(parameters('messagingChannel'), 'telegram'), variables('telegramConfig'), if(equals(parameters('messagingChannel'), 'discord'), variables('discordConfig'), ''))]",

    "setupScript": "[base64(concat('#!/bin/bash\nset -e\nexport DEBIAN_FRONTEND=noninteractive\necho \"[$(date)] Starting OpenCLAW Ultimate setup...\" | tee /var/log/openclaw-setup.log\necho \"[$(date)] AI Provider: ', parameters('aiProvider'), '\" | tee -a /var/log/openclaw-setup.log\necho \"[$(date)] Messaging: ', parameters('messagingChannel'), '\" | tee -a /var/log/openclaw-setup.log\n\n# Install Node.js 22\ncurl -fsSL https://deb.nodesource.com/setup_22.x | bash - >> /var/log/openclaw-setup.log 2>&1\napt-get install -y nodejs >> /var/log/openclaw-setup.log 2>&1\necho \"[$(date)] Node.js installed: $(node --version)\" | tee -a /var/log/openclaw-setup.log\n\n# Install OpenCLAW\nnpm install -g clawdbot >> /var/log/openclaw-setup.log 2>&1\necho \"[$(date)] OpenCLAW installed: $(clawdbot --version)\" | tee -a /var/log/openclaw-setup.log\n\n# Create directories\nmkdir -p /home/', parameters('adminUsername'), '/clawd\nmkdir -p /home/', parameters('adminUsername'), '/.clawdbot\n\n# Create config\ncat > /home/', parameters('adminUsername'), '/.clawdbot/clawdbot.json << ''CONFIGEOF''\n{\"gateway\":{\"mode\":\"local\",\"port\":18789,\"bind\":\"lan\",\"auth\":{\"mode\":\"token\",\"token\":\"', variables('gatewayToken'), '\"}},\"agents\":{\"defaults\":{\"workspace\":\"/home/', parameters('adminUsername'), '/clawd\",\"model\":{\"primary\":\"', variables('selectedModel'), '\"}}}', variables('azureOpenAiProviderConfig'), variables('channelConfig'), '}\nCONFIGEOF\n\n# Create environment file\ncat > /home/', parameters('adminUsername'), '/.clawdbot/env << ''ENVEOF''\n', variables('selectedEnvVar'), '=', parameters('aiApiKey'), '\nENVEOF\n\n# Create systemd service\ncat > /etc/systemd/system/openclaw.service << ''SERVICEEOF''\n[Unit]\nDescription=OpenCLAW Gateway\nAfter=network.target\nWants=network-online.target\n\n[Service]\nType=simple\nUser=', parameters('adminUsername'), '\nWorkingDirectory=/home/', parameters('adminUsername'), '/clawd\nEnvironmentFile=-/home/', parameters('adminUsername'), '/.clawdbot/env\nEnvironment=NODE_ENV=production\nExecStart=/usr/bin/clawdbot gateway\nRestart=always\nRestartSec=10\nStandardOutput=journal\nStandardError=journal\n\n[Install]\nWantedBy=multi-user.target\nSERVICEEOF\n\n# Set permissions\nchown -R ', parameters('adminUsername'), ':', parameters('adminUsername'), ' /home/', parameters('adminUsername'), '/clawd\nchown -R ', parameters('adminUsername'), ':', parameters('adminUsername'), ' /home/', parameters('adminUsername'), '/.clawdbot\nchmod 600 /home/', parameters('adminUsername'), '/.clawdbot/clawdbot.json\nchmod 600 /home/', parameters('adminUsername'), '/.clawdbot/env\n\n# Enable and start service\nsystemctl daemon-reload\nsystemctl enable openclaw\nsystemctl start openclaw\n\n# Create info file\nPUBLIC_IP=$(curl -s ifconfig.me)\ncat > /home/', parameters('adminUsername'), '/OPENCLAW_INFO.txt << EOF\n=====================================\n  OpenCLAW Ultimate Deployment\n=====================================\n\nControl UI: http://${PUBLIC_IP}:18789\nGateway Token: ', variables('gatewayToken'), '\n\nAI Provider: ', parameters('aiProvider'), '\nDefault Model: ', variables('selectedModel'), '\n\nMessaging: ', parameters('messagingChannel'), '\n\nSSH: ssh ', parameters('adminUsername'), '@$(hostname -f)\n\nService Commands:\n  sudo systemctl status openclaw\n  sudo journalctl -u openclaw -f\n\nDocs: https://docs.clawd.bot\n=====================================\nEOF\nchown ', parameters('adminUsername'), ':', parameters('adminUsername'), ' /home/', parameters('adminUsername'), '/OPENCLAW_INFO.txt\n\necho \"[$(date)] OpenCLAW Ultimate setup complete!\" | tee -a /var/log/openclaw-setup.log\n'))]"
  },
  "resources": [
    {
      "condition": "[parameters('deployAzureOpenAI')]",
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2023-05-01",
      "name": "[variables('openAiResourceName')]",
      "location": "[parameters('location')]",
      "kind": "OpenAI",
      "sku": { "name": "[parameters('azureOpenAiSku')]" },
      "properties": {
        "customSubDomainName": "[variables('openAiResourceName')]",
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2023-05-01",
      "name": "[variables('nsgName')]",
      "location": "[parameters('location')]",
      "properties": {
        "securityRules": [
          {
            "name": "SSH",
            "properties": {
              "priority": 1000, "direction": "Inbound", "access": "Allow", "protocol": "TCP",
              "sourcePortRange": "*", "destinationPortRange": "22",
              "sourceAddressPrefix": "*", "destinationAddressPrefix": "*"
            }
          },
          {
            "name": "OpenCLAW-Gateway",
            "properties": {
              "priority": 1010, "direction": "Inbound", "access": "Allow", "protocol": "TCP",
              "sourcePortRange": "*", "destinationPortRange": "18789",
              "sourceAddressPrefix": "*", "destinationAddressPrefix": "*"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2023-05-01",
      "name": "[variables('publicIpName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "Standard" },
      "properties": {
        "publicIPAllocationMethod": "Static",
        "dnsSettings": { "domainNameLabel": "[variables('dnsLabel')]" }
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2023-05-01",
      "name": "[variables('vnetName')]",
      "location": "[parameters('location')]",
      "properties": {
        "addressSpace": { "addressPrefixes": ["10.0.0.0/16"] },
        "subnets": [{ "name": "[variables('subnetName')]", "properties": { "addressPrefix": "10.0.0.0/24" } }]
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-05-01",
      "name": "[variables('nicName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]",
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
      ],
      "properties": {
        "ipConfigurations": [{
          "name": "ipconfig1",
          "properties": {
            "privateIPAllocationMethod": "Dynamic",
            "publicIPAddress": { "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]" },
            "subnet": { "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetName'))]" }
          }
        }],
        "networkSecurityGroup": { "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]" }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-07-01",
      "name": "[parameters('vmName')]",
      "location": "[parameters('location')]",
      "dependsOn": ["[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"],
      "properties": {
        "hardwareProfile": { "vmSize": "[parameters('vmSize')]" },
        "osProfile": {
          "computerName": "[parameters('vmName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[if(equals(parameters('authenticationType'), 'password'), parameters('adminPasswordOrKey'), null())]",
          "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'sshPublicKey'), variables('linuxConfiguration'), null())]"
        },
        "storageProfile": {
          "imageReference": { "publisher": "Canonical", "offer": "ubuntu-24_04-lts", "sku": "server", "version": "latest" },
          "osDisk": { "createOption": "FromImage", "diskSizeGB": 30, "managedDisk": { "storageAccountType": "Standard_LRS" } }
        },
        "networkProfile": { "networkInterfaces": [{ "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]" }] }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "apiVersion": "2023-07-01",
      "name": "[concat(parameters('vmName'), '/OpenCLAWSetup')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]",
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('openAiResourceName'))]"
      ],
      "properties": {
        "publisher": "Microsoft.Azure.Extensions",
        "type": "CustomScript",
        "typeHandlerVersion": "2.1",
        "autoUpgradeMinorVersion": true,
        "protectedSettings": { "script": "[variables('setupScript')]" }
      }
    }
  ],
  "outputs": {
    "publicIPAddress": { "type": "string", "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))).ipAddress]" },
    "fqdn": { "type": "string", "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))).dnsSettings.fqdn]" },
    "sshCommand": { "type": "string", "value": "[concat('ssh ', parameters('adminUsername'), '@', reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))).dnsSettings.fqdn)]" },
    "controlUIUrl": { "type": "string", "value": "[concat('http://', reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))).dnsSettings.fqdn, ':18789')]" },
    "gatewayToken": { "type": "string", "value": "[variables('gatewayToken')]" },
    "aiProvider": { "type": "string", "value": "[parameters('aiProvider')]" },
    "defaultModel": { "type": "string", "value": "[variables('selectedModel')]" },
    "messagingChannel": { "type": "string", "value": "[parameters('messagingChannel')]" },
    "azureOpenAiEndpoint": {
      "condition": "[parameters('deployAzureOpenAI')]",
      "type": "string",
      "value": "[if(parameters('deployAzureOpenAI'), reference(resourceId('Microsoft.CognitiveServices/accounts', variables('openAiResourceName'))).endpoint, '')]"
    },
    "azureOpenAiKey": {
      "condition": "[parameters('deployAzureOpenAI')]",
      "type": "string",
      "value": "[if(parameters('deployAzureOpenAI'), listKeys(resourceId('Microsoft.CognitiveServices/accounts', variables('openAiResourceName')), '2023-05-01').key1, '')]"
    }
  }
}
